!function(a){a(document).ready(function(){$grapher=a(".grapher-box");var b=localStorage.getItem("graphData");$grapher.grapher({},JSON.parse(b)),a(".save, .edit").on("click",function(){b=$grapher.grapher("serialize"),$grapher.grapher("destroy"),$saveEditButton=a(this),$saveEditButton.hasClass("save")?(localStorage.setItem("graphData",JSON.stringify(b)),a(this).removeClass("save").addClass("edit").text("Edit"),$grapher.grapher("load",b,{templateType:"display"},!0)):(a(this).removeClass("edit").addClass("save").text("Save"),b=localStorage.getItem("graphData"),$grapher.grapher({},JSON.parse(b)))})})}(jQuery),function(a){_updateGraphPoint=function(b){b.stopPropagation();var c=a(b.currentTarget),d=parseInt(c.data("point-index"),10);if(_validatePoint(d)){var e=a(b.data.grapher),f=b.data.graphPoints,g=_getSeriesIndex(b.data.grapher),h=_getXYvalues(c);f[g][d]=h,_validateDataPair(h)?e.trigger("graphchange",{seriesIndex:g,dataIndex:d,reindex:!1,action:"update",dataPoint:h}):(c.addClass("pending").removeClass("established"),e.trigger("graphchange",{seriesIndex:g,dataIndex:d,reindex:!0,action:"remove"}))}},_graphRedraw=function(b,c){var d=b.data.chart,e=a(b.data.grapher);switch(c.action){case"remove":d.series[c.seriesIndex].data[c.dataIndex].remove();break;case"update":d.series[c.seriesIndex].data[c.dataIndex].update(c.dataPoint);break;case"add":d.series[c.seriesIndex].addPoint(c.dataPoint);break;case"type":var f=c.newType;_.each(d.series,function(a){a.update({type:f,marker:{radius:_getMarkerSize(f)}})});break;case"bounds":var g=c.graphBounds;d.yAxis[0].setExtremes(g.minY,g.maxY),d.xAxis[0].setExtremes(g.minX,g.maxX);break;case"seriesName":d.series[c.seriesIndex].update({name:c.name})}c.reindex&&e.trigger("reindex"),_checkNoData(d),e.trigger("change")},_validateDataPair=function(a){return a?_.every(a,_validatePoint):void 0},_validatePoint=function(a){return a||0===a?!0:!1},_getSeriesIndex=function(b){return parseInt(a(b).find(".grapher-series.selected").data("series-index"),10)},_getXYvalues=function(a){return[parseFloat(a.find(".grapher-x-input").val()),parseFloat(a.find(".grapher-y-input").val())]},_releasePendingDataPoint=function(b){var c=b.data.graphPoints,d=a(b.data.grapher),e=a(b.currentTarget),f=_getXYvalues(e);if(_validateDataPair(f)){e.removeClass("pending").addClass("established");var g=_getSeriesIndex(b.data.grapher);c[g].push(f),d.trigger("graphchange",{seriesIndex:g,dataPoint:f,reindex:!0,action:"add"})}e.is(":last-child")&&(d.grapherAddEntry(),e.find(".grapher-remove-input").css("visibility","visible"),e.find(".grapher-reorder-input").css("visibility","visible"))},_removeDataItem=function(b){b.stopPropagation();var c=b.data.graphPoints,d=a(b.currentTarget).parents(".grapher-data-item");if(!d.hasClass("invalid")){var e=parseInt(d.data("point-index"),10),f=_getSeriesIndex(b.data.grapher);c[f]=c[f].splice(e,1),a(b.data.grapher).trigger("graphchange",{seriesIndex:f,dataIndex:e,reindex:!1,action:"remove"})}d.remove()},_adjustIndex=function(b){var c=b.data.chart,d=b.data.grapher,e=a(d).find(".grapher-data-item.established");_.each(e,function(b,c){a(b).data("point-index",c)});var f=_getSeriesIndex(d);_.each(e,function(b,d){var e=_getXYvalues(a(b));c.series[f].data[d].update(e)})},_setGraphBounds=function(b){var c=(b.data.chart,a(b.data.grapher)),d=_getCurrentGraphBounds(b.data.grapher);c.trigger("graphchange",{graphBounds:d,reindex:!1,action:"bounds"})},_getCurrentGraphBounds=function(b){var c=a(b),d=parseFloat(c.find(".grapher-x-min").val()),e=parseFloat(c.find(".grapher-x-max").val()),f=parseFloat(c.find(".grapher-y-min").val()),g=parseFloat(c.find(".grapher-y-max").val());return{minX:_validatePoint(d)?d:null,maxX:_validatePoint(e)?e:null,minY:_validatePoint(f)?f:null,maxY:_validatePoint(g)?g:null}},_getDependent=function(a,b){var c=[];return _.each(b,function(b){b[0]===a&&c.push(b[1])}),c.length?c:"â€“"},_changeGraphType=function(b){b.stopPropagation();var c=(b.data.chart,b.data.grapher),d=a(b.currentTarget).data("graph-type");c.trigger("graphchange",{reindex:!1,action:"type",newType:d});var e=c.find(".grapher-graph-selector");e.children().removeClass("selected"),e.find("."+d).addClass("selected")},_getMarkerSize=function(a){switch(a){case"areaspline":return 5;case"line":return 5;case"spline":return 5;case"scatter":return 7;default:return 5}},_checkNoData=function(b){var c=a(b.renderTo),d=0;_.each(b.series,function(a){0===_.size(a.data)&&d++}),d===_.size(b.series)?c.addClass("no-data"):c.removeClass("no-data")},_onDataItemFocus=function(b){$inputEditBox=a(b.currentTarget),$inputEditBox.removeClass("invalid"),$inputEditBox.find(".grapher-remove-input").css("visibility","visible"),$inputEditBox.find(".grapher-reorder-input").css("visibility","visible")},_onDataItemBlur=function(b){$inputEditBox=a(b.currentTarget);var c=_getXYvalues($inputEditBox);_validateDataPair(c)?$inputEditBox.find(".grapher-remove-input").css("visibility","hidden"):$inputEditBox.addClass("invalid"),$inputEditBox.find(".grapher-reorder-input").css("visibility","hidden")},_onSortEnd=function(b){b.stopPropagation();var c=a(b.data.grapher);c.trigger("reindex"),c.trigger("change")},_toggleDataDisplay=function(b){{var c=a(b.data.grapher);b.data.chart}c.find(".grapher-container-right").toggleClass("closed").toggleClass("open");var d=c.find(".grapher-data-slide-title");d.text("Hide Data"===d.text()?"Show Data":"Hide Data")},_onSwitchSeries=function(b){b.stopPropagation();var c=a(b.data.grapher),d=b.data.graphPoints,e=a(b.currentTarget);c.find(".grapher-series.selected").removeClass("selected"),e.addClass("selected"),c.find(".grapher-data-entry").empty();var f=parseInt(e.data("series-index"),10),g=d[f];_.each(g,function(a,b){c.grapherAddEntry(a,b)}),c.grapherAddEntry()},_changeSeriesName=function(b){var c=b.data.grapher,d=(b.data.chart,_getSeriesIndex(c));a(c).trigger("graphchange",{seriesIndex:d,reindex:!1,action:"seriesName",name:a(b.currentTarget).val()})},_onPlotLineSelect=function(){var b=a(this.chart.renderTo).closest(".grapher-box"),c=this.index.toString();b.find('div[data-series-index="'+c+'"]').trigger("pointerdown")},a.fn.grapherAddSeriesTab=function(b,c,d,e){newTab=Handlebars.templates["plot-series-tab"]({index:b,val:c,color:d,selected:e}),a(newTab).appendTo(a(".grapher-series-tabs",this))},a.fn.grapherAddDisplayRow=function(b){newRow=Handlebars.templates["plot-display-row"]({x:b.x,y1:b.y1,y2:b.y2,y3:b.y3}),a(newRow).appendTo(a(".grapher-data-entry",this))},a.fn.grapherAddEntry=function(b,c){var d;if(b||c){d=Handlebars.templates["graph-data-item"]({pointX:b[0],pointY:b[1],index:c,validPoint:_validateDataPair(b)});var e=a(d).appendTo(a(".grapher-data-entry",this)).show("slow");_validateDataPair(b)||(e.removeClass("established").addClass("pending"),e.addClass("invalid"),e.find(".grapher-remove-input").css("visibility","visible"))}else d=Handlebars.templates["graph-data-item"](),a(d).appendTo(a(".grapher-data-entry",this)).show("slow")};var b={higchartsConfig:{chart:{type:"line"},title:{text:"",style:{color:"grey",fontWeight:"bold",fontSize:"3em",letterSpacing:"2px",fontFamily:"Helvetica",lineHeight:"30px"},margin:30},yAxis:{title:{text:"",style:{color:"grey",fontSize:"1.2em",fontFamily:"Helvetica"}},plotLines:[{color:"black",width:2,value:0}],startOnTick:!1,endOnTick:!1},xAxis:{title:{text:"",style:{color:"grey",fontSize:"1.2em",fontFamily:"Helvetica"},margin:30},plotLines:[{color:"black",width:2,value:0}]},legend:{enabled:!1},credits:{enabled:!1},colors:["#9467bd","#36af33","#ff7f0e"],tooltip:{formatter:function(){var b=a(this.series.chart.renderTo).parent(),c=b.find(".grapher-x-axis-title").val()||"X",d=b.find(".grapher-y-axis-title").val()||"Y";return this.series.name+"<br/><br/><b>"+c+": </b>"+this.x+"<br/> <b>"+d+": </b>"+this.y}}},defaultSeriesNum:3},c={init:function(b,c){return this.each(function(){var b=a(this),d=b.data("grapher");d||(initData={graphType:"line",datasets:[{name:"Purple Hippos",points:[[1200,5e3],[1300,19e3],[1400,59e3],[1500,8e4]]},{name:"Green Hippos",points:[[1200,6e3],[1300,9e3],[1400,45e3],[1500,12e4]]},{name:"Series 3",points:[]}],labels:{title:"World Hippo Population",xAxis:"Year",yAxis:"Number of Hippos"},bounds:{minX:null,maxX:null,minY:0,maxY:null}},b.grapher("load",c?c:initData,{templateType:"edit"}),d=b.data("grapher"),b.on("input.grapher",".grapher-data-item.established",d,_.throttle(_updateGraphPoint,400)),b.on("input.grapher",".grapher-bounds-input",d,_.debounce(_setGraphBounds,400)),b.on("input.grapher",".grapher-data-item.pending",d,_releasePendingDataPoint),b.on("input.grapher",".grapher-series-name",d,_.debounce(_changeSeriesName,200)),b.on("focus.grapher",".grapher-data-item:not(:last-child)",_onDataItemFocus),b.on("blur.grapher",".grapher-data-item:not(:last-child)",d,_onDataItemBlur),b.on("click.grapher",".grapher-remove-input",d,_removeDataItem),b.on("click.grapher",".grapher-graph-type",d,_changeGraphType),b.on("click.grapher focus.grapher",".grapher-series:not(.selected)",d,_onSwitchSeries),b.on("reindex.grapher",d,_adjustIndex),b.on("sortupdate.grapher",d,_onSortEnd),b.on("graphchange.grapher",d,_graphRedraw))})},load:function(c,d,e){if(!c)throw new Error("No load data passed");d=d||{};var f=a(this.get(0)),g=a.extend(!0,{},b,d),h=d.templateType,j=Handlebars.templates["plot-data-"+h],k=a(j());k.appendTo(f);var l=f.find(".grapher-display");g.higchartsConfig.chart.renderTo=l.get(0);var m=new Highcharts.Chart(g.higchartsConfig),n=[],o={grapher:this,chart:m,config:g,graphPoints:n};if(f.data("grapher",o),0===_.size(c)){for(i=0;i<g.defaultSeriesNum;i++)o.graphPoints.push([]),m.addSeries({name:"Series "+(i+1),data:[],marker:{radius:7},events:{click:_onPlotLineSelect}}),f.grapherAddSeriesTab(i,"Series "+(i+1),m.options.colors[i],0===i?!0:!1);m.yAxis[0].setExtremes(0,null),m.xAxis[0].setExtremes(0,null)}else{if(_.each(c.datasets,function(a,b){o.graphPoints.push(a.points);var d=_.filter(a.points,_validateDataPair);m.addSeries({name:a.name,data:d,type:c.graphType,marker:{radius:_getMarkerSize(c.graphType)},events:{click:_onPlotLineSelect},grapherIndex:b}),f.grapherAddSeriesTab(b,a.name,m.options.colors[b],0===b),f.find(".grapher-series:first-child").addClass("selected")}),"edit"===h)_.each(_.first(c.datasets).points,function(a,b){f.grapherAddEntry(a,b)});else if("display"===h){var p=[];_.each(c.datasets,function(a){_.each(a.points,function(a){p.push(a[0])})}),p=_.uniq(p.sort(function(a,b){return a-b}),!0),_.each(p,function(a){var b={x:a,y1:_getDependent(a,c.datasets[0].points),y2:_getDependent(a,c.datasets[1].points),y3:_getDependent(a,c.datasets[2].points)};f.grapherAddDisplayRow(b)});var q=f.find(".grapher-details-series-label");_.each(q,function(b,d){a(b).text(c.datasets[d].name)}),f.find(".grapher-details-independent-label").text(c.labels.xAxis||"Independent Variable")}var r=c.bounds.minY,s=c.bounds.maxY,t=c.bounds.minX,u=c.bounds.maxX,v=c.labels;m.yAxis[0].setExtremes(r,s),m.xAxis[0].setExtremes(t,u),e?(m.setTitle({text:v.title}),m.yAxis[0].setTitle({text:v.yAxis}),m.xAxis[0].setTitle({text:v.xAxis})):(f.find(".grapher-title").val(v.title),f.find(".grapher-y-axis-title").val(v.yAxis),f.find(".grapher-x-axis-title").val(v.xAxis),f.find(".grapher-y-min").val(r),f.find(".grapher-y-max").val(s),f.find(".grapher-x-min").val(t),f.find(".grapher-x-max").val(u))}if(e)f.on("click.grapher",".grapher-data-toggle",o,_toggleDataDisplay);else{f.grapherAddEntry(),f.find("."+m.series[0].type).addClass("selected")}_checkNoData(m)},serialize:function(){var b=a(this),c=b.data("grapher").chart,d=b.data("grapher").graphPoints,e=[],f=c.series;return _.each(f,function(a,b){e.push({name:a.name,points:d[b]})}),{graphType:c.series[0].type,datasets:e,labels:{title:b.find(".grapher-title").val(),xAxis:b.find(".grapher-x-axis-title").val(),yAxis:b.find(".grapher-y-axis-title").val()},bounds:_getCurrentGraphBounds(this)}},destroy:function(){return this.each(function(){var b=a(this),c=b.data("grapher");if(!c)throw new ReferenceError("Cannot call destroy on uninitialized grapher");c.chart.destroy(),b.off(".grapher"),b.removeData("grapher"),b.empty()})}};a.fn.grapher=function(b){return c[b]?c[b].apply(this,Array.prototype.slice.call(arguments,1)):"object"!=typeof b&&b?void a.error("Method "+b+" does not exist on jQuery.grapher"):c.init.apply(this,arguments)}}(jQuery);